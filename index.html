<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Input Transaksi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            font-size: 0.875rem; /* sm */
            font-weight: 600;
            color: #4f46e5; /* indigo-600 */
            margin-bottom: 0.5rem;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: white;
            transition: all 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .form-input:focus, .form-select:focus {
            border-color: #6366f1; /* indigo-500 */
            outline: 2px solid #818cf8; /* indigo-400 ring */
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.5);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 1rem;
            height: 1rem;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .channel-btn {
            background-color: #fff;
            color: #4f46e5;
            border: 2px solid #a5b4fc; /* indigo-300 */
            transition: all 0.2s;
        }
        .channel-btn:hover {
            background-color: #eef2ff; /* indigo-50 */
            border-color: #6366f1;
            transform: translateY(-1px);
        }
        .channel-btn.active {
            background-color: #6366f1;
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.5), 0 2px 4px -2px rgba(99, 102, 241, 0.5);
        }
        /* Modal styling */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Style untuk Debug Panel */
        .debug-panel {
            background-color: #fff3cd; /* yellow-100 */
            border-left: 5px solid #ffc107; /* yellow-500 */
            color: #856404; /* yellow-800 */
            padding: 10px;
            margin-top: 20px;
            border-radius: 8px;
            font-size: 0.8rem;
            word-break: break-all;
        }
        .error-placeholder {
            border: 3px solid #f87171; /* red-400 */
            background-color: #fee2e2; /* red-100 */
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: #b91c1c; /* red-700 */
            text-align: center;
            margin-bottom: 1rem;
        }
        /* Style untuk Debt Slideshow */
        #active-debts-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
        }
        #active-debts-list.expanded {
            max-height: 500px; /* Nilai yang cukup besar untuk daftar */
            padding-top: 1rem;
            padding-bottom: 1rem;
            overflow-y: auto; /* Agar bisa di-scroll jika terlalu banyak */
        }
        .debt-list-item {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="max-w-6xl mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
        
        <div id="url-error-reminder" class="error-placeholder" style="display:none;">
            üö® **PERINGATAN PENTING:** Silakan atur `GAS_WEB_APP_URL` di kode Anda! Semua fungsi data akan gagal.
        </div>
        
        <div id="realtime-datetime" class="text-right text-sm font-medium text-gray-400 mb-2">Memuat Waktu...</div>
        <h1 id="greeting" class="text-3xl font-bold mb-2 text-indigo-700">Selamat [Waktu] üëã</h1>
        <p class="text-gray-500 mb-4">Pilih Channel Transaksi, Hapus Hutang, atau Lihat Rekapan Harian.</p>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            
            <div class="bg-indigo-100 border border-indigo-300 p-4 rounded-xl flex justify-between items-center shadow-md">
                <div class="flex flex-col">
                    <p class="text-sm font-medium text-indigo-800">Saldo Flip:</p>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="flip-balance-display" class="text-xl font-extrabold text-indigo-700">
                            Memuat...
                        </span>
                        <button id="toggle-balance-btn" class="text-indigo-500 hover:text-indigo-700 text-xl p-1 rounded-full bg-indigo-200/50">
                            <span id="balance-eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <button id="add-balance-btn" class="text-xs px-3 py-1 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition flex items-center">
                    <span class="text-lg leading-none mr-0.5">+</span> Flip
                </button>
            </div>
            
            <div class="bg-teal-100 border border-teal-300 p-4 rounded-xl flex justify-between items-center shadow-md">
                <div class="flex flex-col">
                    <p class="text-sm font-medium text-teal-800">Cash Ditangan:</p>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="cash-balance-display" class="text-xl font-extrabold text-teal-700">
                            Memuat...
                        </span>
                        <button id="toggle-cash-btn" class="text-teal-500 hover:text-teal-700 text-xl p-1 rounded-full bg-teal-200/50">
                            <span id="cash-eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <button id="add-cash-btn" class="text-xs px-3 py-1 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition flex items-center">
                    <span class="text-lg leading-none mr-0.5">+</span> Cash
                </button>
            </div>
            
            <div class="bg-rose-100 border border-rose-300 p-4 rounded-xl flex justify-between items-center shadow-md col-span-1">
                <div class="flex flex-col">
                    <p class="text-sm font-medium text-rose-800">Total Hutang:</p>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="total-debt-display" class="text-xl font-extrabold text-rose-700">
                            Memuat...
                        </span>
                        <button id="toggle-debt-btn" class="text-rose-500 hover:text-rose-700 text-xl p-1 rounded-full bg-rose-200/50">
                            <span id="eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <button id="refresh-debt-btn" class="text-xs px-3 py-1 bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition">
                    Refresh
                </button>
            </div>
            
            <div class="hidden lg:block"></div> 
            
        </div>
        
        <div id="active-debts-container" class="mb-8">
            <div class="flex justify-center -mt-4 mb-2">
                <button id="toggle-debts-list-btn" class="text-gray-400 hover:text-gray-600 transition duration-150 p-2 text-3xl font-light">
                    <span id="debts-list-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </button>
            </div>

            <div id="active-debts-list" class="bg-white rounded-xl shadow-lg border border-gray-200">
                 <div id="debt-list-content" class="px-4">
                     <p class="text-center text-gray-500 py-4">Klik tombol panah di atas untuk melihat hutang aktif.</p>
                 </div>
            </div>
        </div>
        <div class="flex flex-wrap gap-4 mb-10 border-b pb-6">
            <button data-channel="Flip" class="channel-btn px-6 py-3 rounded-xl font-semibold shadow-md">Flip</button>
            <button data-channel="Gopay" class="channel-btn px-6 py-3 rounded-xl font-semibold shadow-md">Gopay</button>
            <button data-channel="Buku Agen" class="channel-btn px-6 py-3 rounded-xl font-semibold shadow-md">Buku Agen</button>
            <button data-channel="QRIS" class="channel-btn px-6 py-3 rounded-xl font-semibold shadow-md">QRIS</button>
            
            <button id="rekapan-btn" class="px-6 py-3 rounded-xl font-semibold bg-blue-600 text-white shadow-lg hover:bg-blue-700 transition duration-150 ml-auto">
                Lihat Rekapan Harian
            </button>
            
            <button id="struk-btn" class="px-6 py-3 rounded-xl font-semibold bg-cyan-600 text-white shadow-lg hover:bg-cyan-700 transition duration-150">
                Buat Struk
            </button>
            
            <button id="debt-btn" class="px-6 py-3 rounded-xl font-semibold bg-rose-600 text-white shadow-lg hover:bg-rose-700 transition duration-150">
                Hapus Hutang
            </button>
        </div>

        <div id="form-container" class="hidden">
            <h2 class="text-2xl font-bold mb-6 text-indigo-800 border-b pb-3">
                Input Transaksi: <span id="form-title-span">Channel</span>
            </h2>
            <form id="transaction-form" class="needs-validation" novalidate>
                <input type="hidden" name="action" value="submitData">
                <input type="hidden" name="sheetName" id="input-sheetName" value="">
                <input type="hidden" name="channel" id="input-channel" value="">
                <input type="hidden" name="timestamp" id="input-timestamp" value="">
                
                <div id="dynamic-fields" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    </div>
                
                <div class="mt-8 pt-6 border-t flex justify-end">
                    <button type="submit" id="submit-btn" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150">
                        Kirim Data
                    </button>
                </div>
            </form>
        </div>

        <div id="debug-info" class="debug-panel mt-6">
            <p class="font-bold text-sm mb-1">üîç Data Debug:</p>
            <p><strong>URL Apps Script:</strong> <span id="debug-url"></span></p>
            <p><strong>Permintaan Terakhir:</strong> <span id="debug-last-request">N/A</span></p>
            <p><strong>Respon Data Mentah:</strong> <span id="debug-raw-data">N/A</span></p>
        </div>

    </div>

    <div id="message-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 opacity-100">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-indigo-600">Pesan</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-content" class="text-gray-700 text-center">
                </div>
            <div class="mt-6 text-right">
                <button id="modal-close-btn-footer" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Tutup</button>
            </div>
        </div>
    </div>
    
    <div id="add-balance-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-indigo-600">‚ûï Tambah Saldo Flip</h3>
                <button id="balance-modal-close" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            
            <form id="add-balance-form">
                <div class="form-group">
                    <label for="add-balance-amount" class="form-label text-indigo-600">Nominal Penambahan Saldo</label>
                    <input type="text" id="add-balance-amount" name="add-balance-amount" class="form-input text-indigo-700 font-bold text-xl" 
                        placeholder="Contoh: 100000" 
                        oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
                </div>

                <div class="mt-8 pt-4 border-t flex justify-end">
                    <button type="submit" id="add-balance-submit-btn" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150">
                        <span id="add-balance-submit-text">Catat Penambahan</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-cash-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-teal-600">‚ûï Tambah Cash Ditangan</h3>
                <button id="cash-modal-close" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            
            <form id="add-cash-form">
                <div class="form-group">
                    <label for="add-cash-amount" class="form-label text-teal-600">Nominal Penambahan Cash</label>
                    <input type="text" id="add-cash-amount" name="add-cash-amount" class="form-input text-teal-700 font-bold text-xl" 
                        placeholder="Contoh: 500000" 
                        oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
                </div>

                <div class="mt-8 pt-4 border-t flex justify-end">
                    <button type="submit" id="add-cash-submit-btn" class="px-6 py-3 bg-teal-600 text-white font-bold rounded-xl shadow-lg hover:bg-teal-700 transition duration-150">
                        <span id="add-cash-submit-text">Catat Penambahan Cash</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="debt-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-3xl w-full">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-indigo-600">Hapus Hutang (Lunas/Bayar Sebagian)</h3>
                <button id="debt-modal-close" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>

            <div class="grid gap-4">
                <div class="form-group">
                    <label class="form-label">Cari Hutang Berdasarkan Identitas (Nama / No HP / No Rekening)</label>
                    <input id="debt-identitas" class="form-input" placeholder="contoh: Budi / 08123... / 1234567890" />
                </div>

                <div class="flex flex-col sm:flex-row gap-3 items-end">
                    <div class="form-group flex-1 w-full">
                        <label class="form-label">Tanggal Hutang (Opsional)</label>
                        <input id="debt-date" type="date" class="form-input" />
                    </div>
                    <button id="debt-search-btn" class="px-5 py-3 w-full sm:w-auto bg-indigo-600 text-white rounded-xl hover:bg-indigo-700">
                        Cari
                    </button>
                </div>

                <div class="overflow-x-auto rounded-xl border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">Identitas & Tanggal</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase">Nominal Hutang</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="debt-results">
                            <tr><td colspan="3" class="py-4 text-center text-gray-500">Belum ada hasil (silakan cari).</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="partial-payment-modal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-green-600">Pembayaran Sebagian</h3>
                <button id="partial-modal-close" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">Membayar hutang atas nama: <strong id="partial-identitas-text"></strong></p>
            <p class="text-sm text-gray-600 mb-6">Sisa hutang: <strong id="partial-nominal-text" class="text-rose-600"></strong></p>

            <form id="partial-payment-form">
                <input type="hidden" id="partial-debt-id">
                <input type="hidden" id="partial-debt-identitas">
                <input type="hidden" id="partial-debt-nominal">
                <input type="hidden" id="partial-debt-tanggal">

                <div class="form-group">
                    <label for="partial-amount" class="form-label text-green-600">Nominal Dibayar</label>
                    <input type="text" id="partial-amount" name="partial-amount" class="form-input text-green-700 font-bold text-xl" 
                        placeholder="Contoh: 50000" 
                        oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
                </div>

                <div class="mt-8 pt-4 border-t flex justify-end">
                    <button type="submit" id="partial-submit-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition duration-150">
                        <span id="partial-submit-text">Kirim Pembayaran</span>
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // =========================================================================
        // >>>>>>>>>>>>>>>> URL WEB APP GAS BARU ANDA <<<<<<<<<<<<<<<
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbycYP7J-64QT2VoAfGL11FpFf1eeqsUqBlpkkPfbPd9gjYo65u0BKtvAyK0BTl6Uo7uJA/exec'; 
        // --------------------------------------------------------------------------------------------------

        // >>>>>>>>>>>>>>>> URL WEBSITE PEMBUAT STRUK <<<<<<<<<<<<<<<
        const STRUK_WEBSITE_URL = 'https://dwiky106.github.io/cetakstruk'; 
        // --------------------------------------------------------------------------------------------------
        
        // >>>>>>>>>>>>>>>> URL REKAPAN HARIAN (WEBSITE/DASHBOARD) <<<<<<<<<<<<<<<
        const REKAPAN_HARIAN_URL = 'https://dwiky106.github.io/rekapan'; 
        // --------------------------------------------------------------------------------------------------

        // VARIABEL GLOBAL UNTUK TOTAL HUTANG KESELURUHAN
        let currentTotalDebt = 0;
        let isDebtVisible = true; 
        
        // VARIABEL GLOBAL UNTUK SALDO FLIP
        let currentFlipBalance = 0;
        let isBalanceVisible = true; 
        
        // VARIABEL GLOBAL UNTUK CASH DITANGAN 
        let currentCashBalance = 0;
        let isCashVisible = true; 
        
        // VARIABEL GLOBAL UNTUK DAFTAR HUTANG AKTIF
        let activeDebts = [];
        let isDebtsListExpanded = false;
        const ACTIVE_DEBTS_LIMIT = 50; // Batas data yang diambil untuk list aktif

        const CHANNELS = {
            'Flip': {
                products: ['Transfer Uang', 'TOP-UP E-wallet', 'Token Listrik', 'Tagihan Listrik', 'Pulsa', 'Paket Data'],
                ewallets: ['Dana', 'Shopepay', 'Link Aja', 'OVO', 'Gopay', 'i-Saku'],
                sheetName: 'Flip'
            },
            'Gopay': {
                products: ['Pulsa', 'Paket Data', 'Token Listrik', 'Tagihan Listrik'],
                sheetName: 'Gopay'
            },
            'Buku Agen': {
                products: ['Tarik Tunai ATM', 'Transfer ATM', 'Pulsa', 'Paket Data', 'Token Listrik', 'Tagihan Listrik'],
                sheetName: 'Buku Agen'
            },
            'QRIS': {
                products: ['Tarik Tunai'],
                sheetName: 'QRIS'
            }
        };

        let currentChannel = '';

        // --- DOM ELEMENTS (DEBT & GENERAL) ---
        let greetingEl;
        let formContainerEl;
        let formTitleSpanEl;
        let dynamicFieldsEl; 
        let transactionFormEl;
        let submitBtnEl;
        let inputSheetNameEl;
        let inputChannelEl;
        let inputTimestampEl;
        let channelButtons;
        let urlErrorReminderEl;
        let strukBtnEl; 
        let rekapanBtnEl; 
        let totalDebtDisplayEl;
        let toggleDebtBtnEl;
        let eyeIconEl;
        let refreshDebtBtnEl;
        
        // --- REALTIME DATETIME ELEMENT (BARU) ---
        let realtimeDatetimeEl;
        
        // --- ACTIVE DEBTS LIST ELEMENTS ---
        let toggleDebtsListBtnEl;
        let debtsListIconEl;
        let activeDebtsListEl;
        let debtListContentEl;

        // --- FLIP BALANCE DASHBOARD ELEMENTS ---
        let flipBalanceDisplayEl;
        let toggleBalanceBtnEl;
        let balanceEyeIconEl;
        let addBalanceBtnEl;
        
        // --- CASH BALANCE DASHBOARD ELEMENTS ---
        let cashBalanceDisplayEl;
        let toggleCashBtnEl;
        let cashEyeIconEl;
        let addCashBtnEl;
        
        // HILANG: Buku Agen Balance Dashboard Elements


        // --- ADD BALANCE MODAL ELEMENTS ---
        let addBalanceModalEl;
        let balanceModalCloseEl;
        let addBalanceFormEl;
        let addBalanceAmountEl;
        let addBalanceSubmitBtnEl;
        let addBalanceSubmitTextEl;
        
        // --- ADD CASH MODAL ELEMENTS ---
        let addCashModalEl;
        let cashModalCloseEl;
        let addCashFormEl;
        let addCashAmountEl;
        let addCashSubmitBtnEl;
        let addCashSubmitTextEl;
        
        // HILANG: Add Buku Agen Modal Elements


        // --- DEBUG ELEMENTS ---
        let debugUrlEl;
        let debugLastRequestEl;
        let debugRawDataEl; 

        // --- MODAL ELEMENTS ---
        let modalEl;
        let modalTitleEl;
        let modalContentEl;
        let modalCloseBtnEl;
        let modalCloseBtnFooterEl;

        // --- DEBT MODAL ELEMENTS ---
        let debtBtnEl;
        let debtModalEl;
        let debtModalCloseEl;
        let debtSearchBtnEl;
        let debtIdentitasEl;
        let debtDateEl;
        let debtResultsEl;
        
        // --- PARTIAL PAYMENT MODAL ELEMENTS ---
        let partialPaymentModalEl;
        let partialModalCloseEl;
        let partialPaymentFormEl;
        let partialIdentitasTextEl;
        let partialNominalTextEl;
        let partialDebtIdEl;
        let partialDebtIdentitasEl;
        let partialDebtNominalEl;
        let partialDebtTanggalEl;
        let partialAmountEl;
        let partialSubmitBtnEl;
        let partialSubmitTextEl;


        // --- HELPER FUNCTIONS ---
        
        // FUNGSI BARU UNTUK UPDATE WAKTU REAL-TIME PADA DASHBOARD
        function updateRealtimeDatetime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                timeZoneName: 'short'
            };
            const formattedDatetime = now.toLocaleDateString('id-ID', options);
            
            if (realtimeDatetimeEl) {
                realtimeDatetimeEl.textContent = formattedDatetime;
            }
        }
        // END FUNGSI BARU

        function showModal(title, content, isError = false) {
            modalTitleEl.textContent = title;
            modalTitleEl.classList.toggle('text-red-600', isError);
            modalTitleEl.classList.toggle('text-indigo-600', !isError);
            modalContentEl.innerHTML = content;
            modalEl.classList.remove('hidden');
        }

        function hideModal() {
            modalEl.classList.add('hidden');
        }
       
        function setButtonLoading(isLoading, buttonEl = submitBtnEl, loadingText = 'Mengirim...', defaultText = 'Kirim Data') {
            buttonEl.disabled = isLoading;
            if (isLoading) {
                buttonEl.innerHTML = `<span class="spinner"></span> ${loadingText}`;
            } else {
                buttonEl.innerHTML = defaultText;
            }
        }
        
        function setPartialSubmitLoading(isLoading) {
             partialSubmitBtnEl.disabled = isLoading;
            if (isLoading) {
                partialSubmitTextEl.innerHTML = '<span class="spinner"></span> Memproses...';
            } else {
                partialSubmitTextEl.innerHTML = 'Kirim Pembayaran';
            }
        }
        
        function setAddBalanceLoading(isLoading) {
             addBalanceSubmitBtnEl.disabled = isLoading;
            if (isLoading) {
                addBalanceSubmitTextEl.innerHTML = '<span class="spinner"></span> Memproses...';
            } else {
                addBalanceSubmitTextEl.innerHTML = 'Catat Penambahan';
            }
        }

        function setAddCashLoading(isLoading) {
             addCashSubmitBtnEl.disabled = isLoading;
            if (isLoading) {
                addCashSubmitTextEl.innerHTML = '<span class="spinner"></span> Memproses...';
            } else {
                addCashSubmitTextEl.innerHTML = 'Catat Penambahan Cash';
            }
        }
        
        // HILANG: setAddBukuAgenLoading

        function getGreeting() {
            const hour = new Date().getHours();
            let greeting = 'Selamat ';
            if (hour >= 4 && hour < 10) {
                greeting += 'Pagi'; 
            } else if (hour >= 10 && hour < 15) {
                greeting += 'Siang'; 
            } else if (hour >= 15 && hour < 18) {
                greeting += 'Sore'; 
            } else {
                greeting += 'Malam'; 
            }
            if (greetingEl) {
                greetingEl.textContent = `${greeting} Ayangg ü´∂üòòüòò`;
            }
        }

        function createNumberInput(id, label) {
            return `
                <div class="p-3 border border-indigo-200 rounded-xl shadow-inner bg-indigo-50/50">
                    <div class="form-group" id="group-${id}">
                        <label for="${id}" class="form-label">${label}</label>
                        <input type="text" id="${id}" name="${id}" class="form-input" placeholder="Masukkan angka (misalnya 50000)" 
                            oninput="this.value = this.value.replace(/[^0-9-]/g, '');">
                        <p class="text-xs text-gray-500 mt-1">Input hanya angka (boleh negatif).</p>
                    </div>
                </div>
            `;
        }

        function createTextInput(id, label, placeholder = 'Masukkan data') {
            return `
                <div class="form-group">
                    <label for="${id}" class="form-label">${label}</label>
                    <input type="text" id="${id}" name="${id}" class="form-input" placeholder="${placeholder}" required>
                </div>
            `;
        }

        function createSelect(id, label, options, isRequired = true) {
            const optionsHtml = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            return `
                <div class="form-group">
                    <label for="${id}" class="form-label">${label}</label>
                    <select id="${id}" name="${id}" class="form-select" ${isRequired ? 'required' : ''}>
                        <option value="" disabled selected>Pilih salah satu...</option>
                        ${optionsHtml}
                    </select>
                </div>
            `;
        }
        
        function formatRupiah(number) {
            if (isNaN(number)) number = 0;
            
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }
        
        function parseRupiahToNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                let cleanedValue = value.toString().replace(/[^0-9-]/g, '');
                const number = parseInt(cleanedValue.trim(), 10);
                return isNaN(number) ? 0 : number; 
            }
            return 0;
        }

        // --- RETRY MECHANISM ---
        async function fetchWithRetry(url, options, maxRetries = 3) {
            // Cek URL Apps Script yang masih placeholder 
            if (GAS_WEB_APP_URL.includes('AKfycbw') && GAS_WEB_APP_URL.length < 100) {
                 throw new Error("ERROR: URL Web App belum diatur atau masih placeholder.");
            }
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        if (response.headers.get('content-type')?.includes('application/json')) {
                            const errorData = await response.json();
                            if (errorData.error) throw new Error(errorData.error);
                        }
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response; 
                } catch (error) {
                    if (i < maxRetries - 1) {
                         const delay = Math.pow(2, i) * 1000;
                         await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(error.message || `Gagal mengambil data setelah ${maxRetries} percobaan. Cek koneksi internet Anda atau Deploy Apps Script.`);
                    }
                }
            }
        }

        // ============================
        // LOGIKA TOTAL HUTANG DASHBOARD
        // ============================
        
        async function fetchTotalDebt() {
            totalDebtDisplayEl.innerHTML = `<span class="spinner"></span> Loading...`;
            refreshDebtBtnEl.disabled = true;
            
            debugLastRequestEl.textContent = `GET: getTotalDebt`;

            try {
                const url = `${GAS_WEB_APP_URL}?action=getTotalDebt`;
                const res = await fetchWithRetry(url, { method: 'GET' });
                
                let data;
                try {
                    data = await res.json();
                } catch (e) {
                     const rawText = await res.text();
                     throw new Error(`Respon server bukan JSON (Total Debt Gagal). Respon mentah: ${rawText.substring(0, 200)}...`);
                }

                if (data.status !== "SUCCESS" || data.total === undefined) {
                    throw new Error(data.error || "Gagal mendapatkan total hutang.");
                }

                currentTotalDebt = parseRupiahToNumber(data.total); 
                updateDebtDisplay();
                debugLastRequestEl.textContent = `SUCCESS: getTotalDebt`;
                
                // Muat juga daftar hutang aktif (jika sedang dibuka)
                if(isDebtsListExpanded) {
                    await fetchActiveDebts();
                }
                
            } catch (err) {
                totalDebtDisplayEl.textContent = 'Gagal memuat!';
                debtListContentEl.innerHTML = `<p class="text-center text-red-600 font-semibold py-4">Gagal memuat daftar hutang. (${err.message.substring(0, 50)}...)</p>`;
                debugLastRequestEl.textContent = `FAILED: getTotalDebt (${err.message.substring(0, 50)}...)`;
            } finally {
                refreshDebtBtnEl.disabled = false;
            }
        }

        function updateDebtDisplay() {
            if (isDebtVisible) {
                totalDebtDisplayEl.textContent = formatRupiah(currentTotalDebt);
                eyeIconEl.textContent = 'üëÅÔ∏è';
            } else {
                totalDebtDisplayEl.textContent = '*****';
                eyeIconEl.textContent = 'üîí';
            }
        }

        function toggleDebtVisibility() {
            isDebtVisible = !isDebtVisible;
            updateDebtDisplay();
        }
        
        // ============================
        // LOGIKA DAFTAR HUTANG AKTIF (SLIDESHOW)
        // ============================
        
        async function fetchActiveDebts() {
            debtListContentEl.innerHTML = `<p class="text-center text-gray-500 py-4"><span class="spinner" style="border-top: 4px solid #4f46e5;"></span> Memuat ${ACTIVE_DEBTS_LIMIT} hutang terbaru...</p>`;
            
            try {
                const url = `${GAS_WEB_APP_URL}?action=getActiveDebts&limit=${ACTIVE_DEBTS_LIMIT}`;
                const res = await fetchWithRetry(url, { method: 'GET' });
                
                let data;
                try {
                    data = await res.json();
                } catch (e) {
                     const rawText = await res.text();
                     throw new Error(`Respon server bukan JSON (Active Debts Gagal). Respon mentah: ${rawText.substring(0, 200)}...`);
                }

                if (data.status !== "SUCCESS" || !Array.isArray(data.data)) {
                    throw new Error(data.error || "Gagal mendapatkan daftar hutang aktif.");
                }
                
                activeDebts = data.data;
                renderActiveDebtsList();

            } catch (err) {
                debtListContentEl.innerHTML = `<p class="text-center text-red-600 font-semibold py-4">Gagal memuat daftar hutang. (${err.message})</p>`;
            }
        }
        
        function renderActiveDebtsList() {
            if (activeDebts.length === 0) {
                debtListContentEl.innerHTML = `<p class="text-center text-gray-500 py-4">Tidak ada hutang aktif saat ini. ‚ú®</p>`;
                return;
            }
            
            const listHtml = activeDebts.map(it => `
                <div class="debt-list-item flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 border-b last:border-b-0">
                    <div class="flex-1 min-w-0 mb-2 sm:mb-0">
                        <p class="text-sm font-semibold text-gray-900 truncate">${it.identitas || 'N/A'} <span class="text-xs text-gray-400">(${it.sheet})</span></p>
                        <p class="text-xs text-gray-500">Tgl: ${it.tanggal || 'N/A'} | Produk: ${it.produk || 'N/A'}</p>
                        <p class="text-md font-extrabold text-rose-600 mt-1">${formatRupiah(it.nominal)}</p>
                    </div>
                    <button class="px-3 py-1.5 rounded-lg bg-red-600 text-white text-xs font-bold hover:bg-red-700 transition"
                        data-action="set-lunas"
                        data-debt-id="${it.id}"
                        data-identitas="${(it.identitas || '').replace(/"/g,'&quot;')}"
                        data-tanggal="${it.tanggal || ''}"
                        data-nominal="${it.nominal || 0}"
                        data-produk="${it.produk || ''}">
                        Set Lunas
                    </button>
                </div>
            `).join('');
            
            debtListContentEl.innerHTML = `<div class="divide-y divide-gray-100">${listHtml}</div>`;
        }

        function toggleDebtsList() {
            isDebtsListExpanded = !isDebtsListExpanded;
            activeDebtsListEl.classList.toggle('expanded', isDebtsListExpanded);
            
            if (isDebtsListExpanded) {
                // Ganti ikon ke panah atas
                debtsListIconEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                </svg>`;
                // Muat data jika belum dimuat atau perlu refresh
                if (activeDebts.length === 0 || debtListContentEl.textContent.includes('Gagal memuat') || debtListContentEl.textContent.includes('Memuat daftar hutang')) {
                    fetchActiveDebts();
                }
            } else {
                // Ganti ikon ke panah bawah
                debtsListIconEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>`;
            }
        }


        // ============================
        // LOGIKA SALDO FLIP
        // ============================
        
        async function fetchFlipBalance() {
            flipBalanceDisplayEl.innerHTML = `<span class="spinner"></span> Loading...`;
            
            debugLastRequestEl.textContent = `GET: getFlipBalance`;

            try {
                const url = `${GAS_WEB_APP_URL}?action=getFlipBalance`;
                const res = await fetchWithRetry(url, { method: 'GET' });
                
                let data;
                try {
                    data = await res.json();
                } catch (e) {
                     const rawText = await res.text();
                     throw new Error(`Respon server bukan JSON (Saldo Gagal). Respon mentah: ${rawText.substring(0, 200)}...`);
                }

                if (data.status !== "SUCCESS" || data.balance === undefined) {
                    throw new Error(data.error || "Gagal mendapatkan Saldo Flip.");
                }

                currentFlipBalance = parseRupiahToNumber(data.balance); 
                updateBalanceDisplay();
                debugLastRequestEl.textContent = `SUCCESS: getFlipBalance`;
            } catch (err) {
                flipBalanceDisplayEl.textContent = 'Gagal memuat!';
                debugLastRequestEl.textContent = `FAILED: getFlipBalance (${err.message.substring(0, 50)}...)`;
            }
        }

        function updateBalanceDisplay() {
            if (isBalanceVisible) {
                flipBalanceDisplayEl.textContent = formatRupiah(currentFlipBalance);
                balanceEyeIconEl.textContent = 'üëÅÔ∏è';
            } else {
                flipBalanceDisplayEl.textContent = '*****';
                balanceEyeIconEl.textContent = 'üîí';
            }
        }

        function toggleBalanceVisibility() {
            isBalanceVisible = !isBalanceVisible;
            updateBalanceDisplay();
        }
        
        // ============================
        // LOGIKA CASH DITANGAN
        // ============================
        
        async function fetchCashBalance() {
            cashBalanceDisplayEl.innerHTML = `<span class="spinner"></span> Loading...`;
            
            debugLastRequestEl.textContent = `GET: getCashBalance`;

            try {
                const url = `${GAS_WEB_APP_URL}?action=getCashBalance`;
                const res = await fetchWithRetry(url, { method: 'GET' });
                
                let data;
                try {
                    data = await res.json();
                } catch (e) {
                     const rawText = await res.text();
                     throw new Error(`Respon server bukan JSON (Cash Gagal). Respon mentah: ${rawText.substring(0, 200)}...`);
                }

                if (data.status !== "SUCCESS" || data.balance === undefined) {
                    throw new Error(data.error || "Gagal mendapatkan Cash Ditangan.");
                }

                currentCashBalance = parseRupiahToNumber(data.balance); 
                updateCashDisplay();
                debugLastRequestEl.textContent = `SUCCESS: getCashBalance`;
            } catch (err) {
                cashBalanceDisplayEl.textContent = 'Gagal memuat!';
                debugLastRequestEl.textContent = `FAILED: getCashBalance (${err.message.substring(0, 50)}...)`;
            }
        }

        function updateCashDisplay() {
            if (isCashVisible) {
                cashBalanceDisplayEl.textContent = formatRupiah(currentCashBalance);
                cashEyeIconEl.textContent = 'üëÅÔ∏è';
            } else {
                cashBalanceDisplayEl.textContent = '*****';
                cashEyeIconEl.textContent = 'üîí';
            }
        }

        function toggleCashVisibility() {
            isCashVisible = !isCashVisible;
            updateCashDisplay();
        }

        // HILANG: Logika Saldo Buku Agen

        // ============================
        // LOGIKA TAMBAH SALDO FLIP
        // ============================

        function openAddBalanceModal() {
            addBalanceModalEl.classList.remove('hidden');
            addBalanceAmountEl.value = ''; // Reset
        }

        function closeAddBalanceModal() {
            addBalanceModalEl.classList.add('hidden');
        }

        async function handleAddBalance(e) {
            e.preventDefault();
            setAddBalanceLoading(true);

            const amount = parseRupiahToNumber(addBalanceAmountEl.value);

            if (amount <= 0) {
                showModal('Input Tidak Valid', '<p class="text-yellow-600 font-semibold">Nominal penambahan harus lebih besar dari 0.</p>');
                setAddBalanceLoading(false);
                return;
            }

            try {
                debugLastRequestEl.textContent = `POST: addFlipBalance (Nominal: ${amount})`;

                const res = await fetchWithRetry(
                    GAS_WEB_APP_URL,
                    {
                        method: "POST",
                        body: new URLSearchParams({
                            action: "addFlipBalance", 
                            amount: amount 
                        })
                    }
                );

                const data = await res.json();
                
                if (data.status !== "SUCCESS")
                    throw new Error(data.error || "Gagal menambah saldo. Cek balasan error dari Apps Script.");

                closeAddBalanceModal();
                showModal(
                    "Sukses",
                    `<p class='text-green-600 font-semibold'>Penambahan saldo Flip sebesar ${formatRupiah(amount)} berhasil dicatat.</p>`
                );

                // Muat ulang saldo setelah penambahan
                await fetchFlipBalance();

            } catch (err) {
                showModal("Gagal", `<p class='text-red-600 font-semibold'>${err.message}</p>`, true);
            } finally {
                setAddBalanceLoading(false);
            }
        }
        
        // ============================
        // LOGIKA TAMBAH CASH DITANGAN
        // ============================
        
        function openAddCashModal() {
            addCashModalEl.classList.remove('hidden');
            addCashAmountEl.value = ''; // Reset
        }

        function closeAddCashModal() {
            addCashModalEl.classList.add('hidden');
        }

        async function handleAddCash(e) {
            e.preventDefault();
            setAddCashLoading(true);

            const amount = parseRupiahToNumber(addCashAmountEl.value);

            if (amount <= 0) {
                showModal('Input Tidak Valid', '<p class="text-yellow-600 font-semibold">Nominal penambahan cash harus lebih besar dari 0.</p>');
                setAddCashLoading(false);
                return;
            }

            try {
                debugLastRequestEl.textContent = `POST: addCashBalance (Nominal: ${amount})`;

                const res = await fetchWithRetry(
                    GAS_WEB_APP_URL,
                    {
                        method: "POST",
                        body: new URLSearchParams({
                            action: "addCashBalance", 
                            amount: amount 
                        })
                    }
                );

                const data = await res.json();
                
                if (data.status !== "SUCCESS")
                    throw new Error(data.error || "Gagal menambah cash. Cek balasan error dari Apps Script.");

                closeAddCashModal();
                showModal(
                    "Sukses",
                    `<p class='text-green-600 font-semibold'>Penambahan Cash Ditangan sebesar ${formatRupiah(amount)} berhasil dicatat.</p>`
                );

                // Muat ulang saldo setelah penambahan
                await fetchCashBalance();

            } catch (err) {
                showModal("Gagal", `<p class='text-red-600 font-semibold'>${err.message}</p>`, true);
            } finally {
                setAddCashLoading(false);
            }
        }

        // HILANG: Logika Tambah Saldo Buku Agen


        // --- FORM RENDERING & DYNAMICS ---
        function renderForm(channel) {
            currentChannel = channel;
            formTitleSpanEl.textContent = channel;
            formContainerEl.classList.remove('hidden');
            
            // Set hidden inputs
            inputSheetNameEl.value = CHANNELS[channel].sheetName;
            inputChannelEl.value = channel;

            const config = CHANNELS[channel];
            
            let html = '';

            // BARIS 1: IDENTITAS & PRODUK
            html += createTextInput('identitas', 'Nama User/Identitas', 'Masukkan nama pelanggan (boleh angka dan huruf)'); 
            html += createSelect('produk', 'Produk', config.products);

            // BARIS 2: E-WALLET & STATUS
            if (channel === 'Flip') {
                html += '<div id="ewallet-dropdown-placeholder" class="form-group hidden"></div>'; // Kolom E
            } else {
                html += '<div></div>'; // Placeholder
            }
            
            // Kolom F: Status
            html += createSelect('status', 'Status Transaksi', ['Lunas', 'Terhutang']); 
            
            // BARIS 3: HARGA CHANNEL & JUAL
            html += createNumberInput('hargaChannel', 'Harga Channel (Modal)'); 
            html += createNumberInput('hargaJual', 'Harga Jual (Penerimaan)'); 
            
            // BARIS 4: CASH & ONLINE MASUK
            html += createNumberInput('cashDiterimaAgen', 'Cash Diterima Agen'); 
            html += createNumberInput('onlineMasuk', 'Online Masuk'); 
            
            // BARIS 5: JUMLAH TERHUTANG (KOLOM K) - Selalu ada placeholder
            html += '<div id="terhutang-input-placeholder" class="form-group hidden md:col-span-2"></div>'; // Kolom K

            dynamicFieldsEl.innerHTML = html;
            transactionFormEl.reset(); // Reset form

            // Tambahkan event listener untuk dinamika form
            document.getElementById('produk')?.addEventListener('change', handleProductChange);
            document.getElementById('status')?.addEventListener('change', handleStatusChange);

            // Update active state for buttons
            channelButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[data-channel="${channel}"]`).classList.add('active');
        }

        function handleProductChange(event) {
            const product = event.target.value;
            const ewalletPlaceholder = document.getElementById('ewallet-dropdown-placeholder');
            const ewalletInput = document.getElementById('ewallet');

            if (currentChannel === 'Flip' && product === 'TOP-UP E-wallet') {
                if (ewalletPlaceholder) {
                    ewalletPlaceholder.innerHTML = createSelect('ewallet', 'Pilih E-wallet', CHANNELS['Flip'].ewallets);
                    document.getElementById('ewallet')?.setAttribute('required', 'required');
                    ewalletPlaceholder.classList.remove('hidden');
                }
            } else {
                if (ewalletPlaceholder) {
                    ewalletPlaceholder.innerHTML = '';
                    ewalletPlaceholder.classList.add('hidden');
                    if (ewalletInput) ewalletInput.removeAttribute('required');
                }
            }
        }

        function handleStatusChange(event) {
            const status = event.target.value;
            const terhutangPlaceholder = document.getElementById('terhutang-input-placeholder');

            if (status === 'Terhutang') {
                if (terhutangPlaceholder) {
                    terhutangPlaceholder.innerHTML = createNumberInput('jumlahTerhutang', 'Jumlah Terhutang (Kolom K)');
                    
                    const numInput = document.getElementById('jumlahTerhutang');
                    if (numInput) {
                        numInput.oninput = function() { this.value = this.value.replace(/[^0-9-]/g, ''); };
                        numInput.setAttribute('required', 'required');
                    }

                    terhutangPlaceholder.classList.remove('hidden');
                }
            } else {
                if (terhutangPlaceholder) {
                    terhutangPlaceholder.innerHTML = '';
                    terhutangPlaceholder.classList.add('hidden');
                }
            }
        }


        // ============================
        // DEBT (HAPUS / PEMBAYARAN HUTANG)
        // ============================

        function openDebtModal() {
            debtModalEl.classList.remove('hidden');
            // debtDateEl.value = new Date().toISOString().split('T')[0]; // Tidak perlu set tanggal secara default
            debtIdentitasEl.focus();
        }

        function closeDebtModal() {
            debtModalEl.classList.add('hidden');
        }
        
        function getButtonContext(btn) {
            return {
                debtId: btn.dataset.debtId,
                identitas: btn.dataset.identitas || "",
                tanggal: btn.dataset.tanggal || "",
                nominal: parseRupiahToNumber(btn.dataset.nominal || 0),
                produk: btn.dataset.produk || "" 
            };
        }


        async function searchDebt() {
            const ident = (debtIdentitasEl.value || '').trim();
            const date = debtDateEl.value;

            if (!ident) {
                showModal('Form Tidak Lengkap', '<p class="text-yellow-600 font-semibold">Isi identitas terlebih dahulu.</p>');
                return;
            }

            debtResultsEl.innerHTML = `
                <tr><td colspan="3" class="py-4 text-center text-gray-500">Mencari...</td></tr>
            `;
            
            debugLastRequestEl.textContent = `GET: searchDebt (Identitas: ${ident}, Tanggal: ${date})`;

            try {
                const url = `${GAS_WEB_APP_URL}?action=searchDebt&identitas=${encodeURIComponent(ident)}${date ? '&date=' + encodeURIComponent(date) : ''}`;
                const res = await fetchWithRetry(url, { method: 'GET' });
                
                let data;
                try {
                    data = await res.json();
                } catch (e) {
                     const rawText = await res.text();
                     throw new Error(`Respon server bukan JSON (Debt Search Gagal). Respon mentah: ${rawText.substring(0, 200)}...`);
                }
                
                debugRawDataEl.textContent = JSON.stringify(data).substring(0, 300) + '...';

                if (data.status !== "SUCCESS") {
                    throw new Error(data.error || "Pencarian hutang gagal.");
                }

                renderDebtResults(data.data || []);
                debugLastRequestEl.textContent = `SUCCESS: searchDebt`;
            } catch (err) {
                debtResultsEl.innerHTML = `
                <tr><td colspan="3" class="py-4 text-center text-red-600 font-semibold">${err.message}</td></tr>
                `;
                debugLastRequestEl.textContent = `FAILED: searchDebt (${err.message.substring(0, 50)}...)`;
            }
        }

        function renderDebtResults(items) {
            if (!items || items.length === 0) {
                debtResultsEl.innerHTML =
                    `<tr><td colspan="3" class="py-4 text-center text-gray-500">Tidak ditemukan hutang.</td></tr>`;
                return;
            }

            debtResultsEl.innerHTML = items.map(it => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">
                        ${it.identitas || '-'}
                        <div class="text-xs text-gray-500 mt-1">Tgl: ${it.tanggal || 'N/A'} | Produk: ${it.produk || 'N/A'}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-right font-semibold text-rose-600">
                        ${formatRupiah(it.nominal)}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex gap-2 justify-center flex-wrap">
                            <button class="px-3 py-2 rounded-lg bg-green-500 text-white text-sm hover:bg-green-600"
                                data-action="partial-pay"
                                data-debt-id="${it.id}"
                                data-identitas="${(it.identitas || '').replace(/"/g,'&quot;')}"
                                data-tanggal="${it.tanggal || ''}"
                                data-nominal="${it.nominal || 0}">
                                Bayar Sebagian
                            </button>
                            <button class="px-3 py-2 rounded-lg bg-green-700 text-white text-sm hover:bg-green-800"
                                data-action="set-lunas"
                                data-debt-id="${it.id}"
                                data-identitas="${(it.identitas || '').replace(/"/g,'&quot;')}"
                                data-tanggal="${it.tanggal || ''}"
                                data-nominal="${it.nominal || 0}">
                                Set Lunas
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // ============================
        // LOGIKA SET LUNAS
        // ============================
        async function setLunas(ctx, isFromList = false, targetButton) {
            const button = targetButton || event.target.closest('button');
            const originalHtml = button.innerHTML;
            
            // Dapatkan nominal terbaru (untuk pesan konfirmasi)
            const currentNominal = isFromList ? ctx.nominal : parseRupiahToNumber(targetButton.dataset.nominal || 0);

            try {
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span> Proses...';

                debugLastRequestEl.textContent = `POST: updateDebt (ID: ${ctx.debtId}, Mode: lunas)`;

                const res = await fetchWithRetry(
                    GAS_WEB_APP_URL,
                    {
                        method: "POST",
                        body: new URLSearchParams({
                            action: "updateDebt", 
                            mode: "lunas",
                            debtId: ctx.debtId
                        })
                    }
                );

                let data;
                try {
                    data = await res.json();
                } catch (e) {
                     const rawText = await res.text();
                     throw new Error(`Respon server bukan JSON (Set Lunas Gagal). Respon mentah: ${rawText.substring(0, 200)}...`);
                }

                debugRawDataEl.textContent = JSON.stringify(data).substring(0, 300) + '...';

                if (data.status !== "SUCCESS")
                    throw new Error(data.error || "Gagal set lunas. Cek balasan error dari Apps Script.");

                showModal(
                    "Sukses",
                    `<p class='text-green-600 font-semibold'>Hutang ${ctx.identitas} sebesar ${formatRupiah(currentNominal)} berhasil dihapus (set lunas).</p>`
                );

                // Setelah berhasil, muat ulang Total Debt & Active Debts
                await fetchTotalDebt();
                if (!isFromList) await searchDebt(); // Hanya refresh hasil pencarian jika dari modal Hapus Hutang

            } catch (err) {
                showModal("Gagal", `<p class='text-red-600 font-semibold'>${err.message}</p>`, true);
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        
        // ============================
        // LOGIKA BAYAR SEBAGIAN
        // ============================

        function openPartialPaymentModal(ctx) {
            partialDebtIdEl.value = ctx.debtId;
            partialDebtIdentitasEl.value = ctx.identitas;
            partialDebtNominalEl.value = ctx.nominal;
            partialDebtTanggalEl.value = ctx.tanggal;

            partialIdentitasTextEl.textContent = ctx.identitas;
            partialNominalTextEl.textContent = formatRupiah(ctx.nominal);
            partialAmountEl.value = ''; // Reset input
            
            partialPaymentModalEl.classList.remove('hidden');
        }
        
        function closePartialPaymentModal() {
            partialPaymentModalEl.classList.add('hidden');
        }

        async function handlePartialPayment(e) {
            e.preventDefault();
            setPartialSubmitLoading(true);

            const ctx = {
                debtId: partialDebtIdEl.value,
                identitas: partialDebtIdentitasEl.value,
                nominalAwal: parseRupiahToNumber(partialDebtNominalEl.value),
                tanggal: partialDebtTanggalEl.value,
                nominalBayar: parseRupiahToNumber(partialAmountEl.value)
            };
            
            if (ctx.nominalBayar <= 0) {
                showModal('Input Tidak Valid', '<p class="text-yellow-600 font-semibold">Nominal yang dibayar harus lebih besar dari 0.</p>');
                setPartialSubmitLoading(false);
                return;
            }
            
            if (ctx.nominalBayar > ctx.nominalAwal) {
                 showModal('Input Tidak Valid', '<p class="text-yellow-600 font-semibold">Nominal yang dibayar tidak boleh melebihi sisa hutang.</p>');
                setPartialSubmitLoading(false);
                return;
            }


            try {
                debugLastRequestEl.textContent = `POST: updateDebt (ID: ${ctx.debtId}, Mode: partial, Nominal: ${ctx.nominalBayar})`;

                const res = await fetchWithRetry(
                    GAS_WEB_APP_URL,
                    {
                        method: "POST",
                        body: new URLSearchParams({
                            action: "updateDebt", 
                            mode: "partial",
                            debtId: ctx.debtId,
                            amount: ctx.nominalBayar 
                        })
                    }
                );

                let data;
                try {
                    data = await res.json();
                } catch (e) {
                     const rawText = await res.text();
                     throw new Error(`Respon server bukan JSON (Bayar Sebagian Gagal). Respon mentah: ${rawText.substring(0, 200)}...`);
                }

                debugRawDataEl.textContent = JSON.stringify(data).substring(0, 300) + '...';

                if (data.status !== "SUCCESS")
                    throw new Error(data.error || "Gagal bayar sebagian. Cek balasan error dari Apps Script.");

                closePartialPaymentModal();
                showModal(
                    "Sukses",
                    `<p class='text-green-600 font-semibold'>Pembayaran sebagian sebesar ${formatRupiah(ctx.nominalBayar)} berhasil dicatat.</p>` +
                    `<p class='text-sm mt-2'>Sisa hutang terbaru akan terlihat setelah pencarian ulang.</p>`
                );

                // Muat ulang hasil pencarian hutang & Total Debt
                await searchDebt();
                await fetchTotalDebt();

            } catch (err) {
                showModal("Gagal", `<p class='text-red-600 font-semibold'>${err.message}</p>`, true);
            } finally {
                setPartialSubmitLoading(false);
            }
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Inisialisasi semua elemen DOM
            
            // --- General Elements ---
            greetingEl = document.getElementById('greeting');
            formContainerEl = document.getElementById('form-container');
            formTitleSpanEl = document.getElementById('form-title-span');
            dynamicFieldsEl = document.getElementById('dynamic-fields'); 
            transactionFormEl = document.getElementById('transaction-form');
            submitBtnEl = document.getElementById('submit-btn');
            inputSheetNameEl = document.getElementById('input-sheetName');
            inputChannelEl = document.getElementById('input-channel');
            // inputTimestampEl tidak perlu, karena kita set langsung di submit listener
            inputTimestampEl = document.getElementById('input-timestamp'); 
            channelButtons = document.querySelectorAll('.channel-btn');
            urlErrorReminderEl = document.getElementById('url-error-reminder');
            
            // --- Elemen Tombol Tambahan ---
            strukBtnEl = document.getElementById('struk-btn');
            rekapanBtnEl = document.getElementById('rekapan-btn');
            
            // --- REALTIME DATETIME ELEMENT (BARU) ---
            realtimeDatetimeEl = document.getElementById('realtime-datetime');
            
            // --- DEBT DASHBOARD ELEMENTS ---
            totalDebtDisplayEl = document.getElementById('total-debt-display');
            toggleDebtBtnEl = document.getElementById('toggle-debt-btn');
            eyeIconEl = document.getElementById('eye-icon');
            refreshDebtBtnEl = document.getElementById('refresh-debt-btn');
            
            // --- ACTIVE DEBTS LIST ELEMENTS ---
            toggleDebtsListBtnEl = document.getElementById('toggle-debts-list-btn');
            debtsListIconEl = document.getElementById('debts-list-icon');
            activeDebtsListEl = document.getElementById('active-debts-list');
            debtListContentEl = document.getElementById('debt-list-content');
            
            // --- FLIP BALANCE DASHBOARD ELEMENTS ---
            flipBalanceDisplayEl = document.getElementById('flip-balance-display');
            toggleBalanceBtnEl = document.getElementById('toggle-balance-btn');
            balanceEyeIconEl = document.getElementById('balance-eye-icon');
            addBalanceBtnEl = document.getElementById('add-balance-btn');
            
            // --- CASH BALANCE DASHBOARD ELEMENTS ---
            cashBalanceDisplayEl = document.getElementById('cash-balance-display');
            toggleCashBtnEl = document.getElementById('toggle-cash-btn');
            cashEyeIconEl = document.getElementById('cash-eye-icon');
            addCashBtnEl = document.getElementById('add-cash-btn');
            
            // HILANG: Buku Agen Balance Dashboard Elements


            // --- ADD BALANCE MODAL ELEMENTS ---
            addBalanceModalEl = document.getElementById('add-balance-modal');
            balanceModalCloseEl = document.getElementById('balance-modal-close');
            addBalanceFormEl = document.getElementById('add-balance-form');
            addBalanceAmountEl = document.getElementById('add-balance-amount');
            addBalanceSubmitBtnEl = document.getElementById('add-balance-submit-btn');
            addBalanceSubmitTextEl = document.getElementById('add-balance-submit-text');
            
            // --- ADD CASH MODAL ELEMENTS ---
            addCashModalEl = document.getElementById('add-cash-modal');
            cashModalCloseEl = document.getElementById('cash-modal-close');
            addCashFormEl = document.getElementById('add-cash-form');
            addCashAmountEl = document.getElementById('add-cash-amount');
            addCashSubmitBtnEl = document.getElementById('add-cash-submit-btn');
            addCashSubmitTextEl = document.getElementById('add-cash-submit-text');
            
            // HILANG: Add Buku Agen Modal Elements


            // --- Debug, Modal, Debt, Partial Elements ---
            debugUrlEl = document.getElementById('debug-url');
            debugLastRequestEl = document.getElementById('debug-last-request');
            debugRawDataEl = document.getElementById('debug-raw-data');
            modalEl = document.getElementById('message-modal');
            modalTitleEl = document.getElementById('modal-title');
            modalContentEl = document.getElementById('modal-content');
            modalCloseBtnEl = document.getElementById('modal-close-btn');
            modalCloseBtnFooterEl = document.getElementById('modal-close-btn-footer');
            debtBtnEl = document.getElementById('debt-btn');
            debtModalEl = document.getElementById('debt-modal');
            debtModalCloseEl = document.getElementById('debt-modal-close');
            debtSearchBtnEl = document.getElementById('debt-search-btn');
            debtIdentitasEl = document.getElementById('debt-identitas');
            debtDateEl = document.getElementById('debt-date');
            debtResultsEl = document.getElementById('debt-results');
            partialPaymentModalEl = document.getElementById('partial-payment-modal');
            partialModalCloseEl = document.getElementById('partial-modal-close');
            partialPaymentFormEl = document.getElementById('partial-payment-form');
            partialIdentitasTextEl = document.getElementById('partial-identitas-text');
            partialNominalTextEl = document.getElementById('partial-nominal-text');
            partialDebtIdEl = document.getElementById('partial-debt-id');
            partialDebtIdentitasEl = document.getElementById('partial-debt-identitas');
            partialDebtNominalEl = document.getElementById('partial-debt-nominal');
            partialDebtTanggalEl = document.getElementById('partial-debt-tanggal');
            partialAmountEl = document.getElementById('partial-amount');
            partialSubmitBtnEl = document.getElementById('partial-submit-btn');
            partialSubmitTextEl = document.getElementById('partial-submit-text');


            // 2. Pasang semua Event Listeners
            
            // Global Modal Listeners 
            modalCloseBtnEl.addEventListener('click', hideModal);
            modalCloseBtnFooterEl.addEventListener('click', hideModal); 
            
            // Total Debt Listeners
            toggleDebtBtnEl.addEventListener('click', toggleDebtVisibility);
            refreshDebtBtnEl.addEventListener('click', async () => {
                await fetchTotalDebt();
                await fetchFlipBalance();
                await fetchCashBalance(); 
                // HILANG: Refresh Buku Agen
            });
            
            // Active Debts List Listener (NEW)
            toggleDebtsListBtnEl.addEventListener('click', toggleDebtsList);
            debtListContentEl.addEventListener('click', async (e) => {
                const target = e.target.closest("button[data-action='set-lunas']");
                if (!target) return;
                
                const ctx = getButtonContext(target);
                // Konfirmasi dulu
                 if (confirm(`Anda yakin ingin menghapus (set Lunas) hutang atas nama ${ctx.identitas} sebesar ${formatRupiah(ctx.nominal)}?`)) {
                    await setLunas(ctx, true, target);
                 }
            });


            // Flip Balance Listeners 
            toggleBalanceBtnEl.addEventListener('click', toggleBalanceVisibility);
            addBalanceBtnEl.addEventListener('click', openAddBalanceModal);
            
            // Cash Balance Listeners
            toggleCashBtnEl.addEventListener('click', toggleCashVisibility);
            addCashBtnEl.addEventListener('click', openAddCashModal);
            
            // HILANG: Buku Agen Balance Listeners


            // Add Balance Modal Listeners 
            balanceModalCloseEl.addEventListener('click', closeAddBalanceModal);
            addBalanceFormEl.addEventListener('submit', handleAddBalance);
            
            // Add Cash Modal Listeners
            cashModalCloseEl.addEventListener('click', closeAddCashModal);
            addCashFormEl.addEventListener('submit', handleAddCash);
            
            // HILANG: Add Buku Agen Modal Listeners


            // Form Submission Listener 
            transactionFormEl.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Cek sekali lagi apakah URL Apps Script sudah valid
                if (GAS_WEB_APP_URL.includes('AKfycbw') && GAS_WEB_APP_URL.length < 100) {
                    showModal('ERROR PENTING', '<p class="text-red-600 font-semibold">URL Web App Apps Script belum diatur!</p>', true);
                    urlErrorReminderEl.style.display = 'block';
                    return;
                }
                
                if (!transactionFormEl.checkValidity()) {
                    showModal('Validasi Data', '<p class="text-yellow-600 font-semibold">Mohon lengkapi semua field yang diperlukan!</p>', false);
                    return;
                }

                setButtonLoading(true);

                const formData = new FormData(transactionFormEl);

                const numberInputs = ['hargaChannel', 'hargaJual', 'cashDiterimaAgen', 'onlineMasuk', 'jumlahTerhutang'];
                for (const key of numberInputs) {
                    let value = formData.get(key) || '';
                    value = value.toString().replace(/[^0-9-]/g, '');
                    formData.set(key, value); 
                }

                // PERBAIKAN: Mengambil timestamp saat submit dengan format Date ISO untuk Apps Script
                const timestamp = new Date().toISOString(); 
                formData.set('timestamp', timestamp);
                
                debugLastRequestEl.textContent = `POST: submitData (${currentChannel})`;


                try {
                    const response = await fetchWithRetry(GAS_WEB_APP_URL, {
                        method: 'POST',
                        body: formData 
                    });
                    
                    const result = await response.json();
                    debugRawDataEl.textContent = JSON.stringify(result).substring(0, 300) + '...';

                    if (result.status === "SUCCESS") {
                        showModal('Status Pengiriman Data', `<p class="text-green-600 font-semibold">Data transaksi <b>(${currentChannel})</b> berhasil dikirim.</p>`);
                        
                        // --- RESET UI SETELAN SUKSES ---
                        transactionFormEl.reset();
                        document.getElementById('ewallet-dropdown-placeholder')?.classList.add('hidden');
                        document.getElementById('terhutang-input-placeholder')?.classList.add('hidden');
                        formContainerEl.classList.add('hidden');
                        channelButtons.forEach(btn => btn.classList.remove('active'));
                        urlErrorReminderEl.style.display = 'none';
                        debugLastRequestEl.textContent = `SUCCESS: submitData`;
                        
                        // REFRESH SEMUA DASHBOARD SETELAH SUBMIT DATA
                        await fetchTotalDebt(); 
                        await fetchFlipBalance();
                        await fetchCashBalance(); 
                        // HILANG: Refresh Buku Agen

                    } else {
                        // Jika status ERROR dari Apps Script
                        throw new Error(result.error || "Gagal Kirim Data: Respon Apps Script tidak sesuai.");
                    }

                } catch (error) {
                    console.error('Error saat submit data:', error);
                    let displayError = error.message || "Terjadi error saat mengirim data ke Apps Script.";
                    
                    if (displayError.includes('URL Web App belum diatur')) {
                        urlErrorReminderEl.style.display = 'block';
                    }

                    showModal('Gagal Kirim Data', `<p class="text-red-600 font-semibold">${displayError}</p>`, true);
                    debugLastRequestEl.textContent = `FAILED: submitData (${error.message.substring(0, 50)}...)`;
                } finally {
                    setButtonLoading(false);
                }
            });

            // Channel Selection Listeners 
            channelButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const channel = e.target.dataset.channel;
                    if (currentChannel === channel && !formContainerEl.classList.contains('hidden')) {
                        formContainerEl.classList.add('hidden');
                        currentChannel = '';
                        button.classList.remove('active');
                    } else {
                        renderForm(channel);
                    }
                });
            });
            
            // Listener Tombol Buat Struk
            strukBtnEl.addEventListener('click', () => {
                window.open(STRUK_WEBSITE_URL, '_blank');
            });
            
            // Listener Tombol Rekapan Harian
            rekapanBtnEl.addEventListener('click', () => {
                window.open(REKAPAN_HARIAN_URL, '_blank');
            });


            // Debt Modal Listeners 
            debtBtnEl.addEventListener("click", openDebtModal);
            debtModalCloseEl.addEventListener("click", closeDebtModal);
            debtSearchBtnEl.addEventListener("click", searchDebt);

            // Debt Action Delegation Listener (from Modal)
            debtResultsEl.addEventListener('click', async (e) => {
                const target = e.target.closest("button");
                if (!target) return;
                
                const action = target.dataset.action;
                if (!action) {
                    console.error("Kesalahan: Tombol tidak memiliki data-action.");
                    showModal('Error Aksi', '<p class="text-red-600 font-semibold">Tombol aksi tidak valid. Mohon hubungi developer.</p>', true);
                    return;
                }

                const ctx = getButtonContext(target);

                if (action === "set-lunas") {
                     // Konfirmasi dulu
                     if (confirm(`Anda yakin ingin menghapus (set Lunas) hutang atas nama ${ctx.identitas} sebesar ${formatRupiah(ctx.nominal)}?`)) {
                        await setLunas(ctx);
                     }
                } else if (action === "partial-pay") {
                    openPartialPaymentModal(ctx);
                }
            });
            
            // Partial Payment Modal Listeners
            partialModalCloseEl.addEventListener('click', closePartialPaymentModal);
            partialPaymentFormEl.addEventListener('submit', handlePartialPayment);


            // 3. Setup Awal
            getGreeting();
            
            // Setup Real-time Clock
            updateRealtimeDatetime();
            setInterval(updateRealtimeDatetime, 1000); // Kunci Real-time: Update setiap 1 detik
            
            // Tampilkan URL Apps Script di debug panel saat inisialisasi
            debugUrlEl.textContent = GAS_WEB_APP_URL;

            // Panggil fungsi untuk memuat semua saldo dan hutang saat halaman dimuat
            fetchTotalDebt(); // Ini akan memuat Total Debt dan Active Debts (jika diperluas)
            fetchFlipBalance();
            fetchCashBalance(); 
            // HILANG: Panggil fetchBukuAgenBalance

            // Tampilkan pengingat jika URL Apps Script terlihat seperti placeholder atau bermasalah
            if (GAS_WEB_APP_URL.includes('AKfycbw') && GAS_WEB_APP_URL.length < 100) {
                 urlErrorReminderEl.style.display = 'block';
            } else {
                 urlErrorReminderEl.style.display = 'none';
            }
        });
    </script>
</body>
</html>
